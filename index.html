<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CarsMongolia.mn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap");
        body {
            font-family: "Inter", sans-serif;
            background-color: #f6f7f7;
        }
        /* Style for image thumbnail border on detail modal */
        .thumb-active {
            outline: 2px solid #ef4444;
            outline-offset: 2px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-red-600">CarsMongolia.mn</h1>
            <button id="open-modal-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-lg hover:bg-red-700 transition duration-150 flex items-center space-x-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                <span>Зар Оруулах</span>
            </button>
        </div>
    </header>

    <!-- Filter Bar -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 bg-white shadow-inner mb-6">
        <div class="space-y-3">
            <!-- Manufacturer / Model -->
            <div class="flex flex-col md:flex-row md:space-x-4 space-y-3 md:space-y-0">
                <select id="filter-manufacturer" class="w-full md:w-1/2 border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-red-500 focus:border-red-500">
                    <option value="all">Бүх үйлдвэрлэгч</option>
                </select>
                <select id="filter-model" class="w-full md:w-1/2 border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-red-500 focus:border-red-500">
                    <option value="all">Бүх модель</option>
                </select>
            </div>
            <!-- Year / Price -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                <input id="filter-year-min" type="number" placeholder="Он (доод)" class="border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-red-500 focus:border-red-500"/>
                <input id="filter-year-max" type="number" placeholder="Он (дээд)" class="border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-red-500 focus:border-red-500"/>
                <input id="filter-price-min" type="number" step="0.1" placeholder="Үнэ мин (сая ₮)" class="border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-red-500 focus:border-red-500"/>
                <div class="flex space-x-2">
                    <input id="filter-price-max" type="number" step="0.1" placeholder="Үнэ макс (сая ₮)" class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-red-500 focus:border-red-500"/>
                    <button id="clear-filters" class="whitespace-nowrap bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs md:text-sm font-semibold px-3 py-2 rounded-lg">
                        Цэвэрлэх
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Listings -->
    <main id="listings-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-12">
        <div id="loading-message" class="col-span-full text-center py-20 text-gray-500 font-semibold text-lg">
            Машины зарнуудыг ачаалж байна...
        </div>
    </main>

    <!-- Add Car Modal -->
    <div id="add-car-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-20 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6">
                <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4 flex justify-between items-center">
                    Машины Зар Оруулах
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </h2>

                <form id="add-car-form" class="space-y-4 text-sm">
                    <!-- Manufacturer / Model -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="manufacturer" class="block font-medium text-gray-700">Үйлдвэрлэгч *</label>
                            <input type="text" id="manufacturer" name="manufacturer" placeholder="Acura, Lexus, Toyota..." class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:ring-red-500 focus:border-red-500" required />
                        </div>
                        <div>
                            <label for="model" class="block font-medium text-gray-700">Модель *</label>
                            <input type="text" id="model" name="model" placeholder="MDX, RX450h..." class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:ring-red-500 focus:border-red-500" required />
                        </div>
                    </div>

                    <!-- Main specs row -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label for="year" class="block font-medium text-gray-700">Үйлдвэрлэсэн он *</label>
                            <input type="number" id="year" name="year" placeholder="2007" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 focus:ring-red-500 focus:border-red-500" min="1980" max="2099" required />
                        </div>
                        <div>
                            <label for="importYear" class="block font-medium text-gray-700">Орж ирсэн он</label>
                            <input type="number" id="importYear" name="importYear" placeholder="2012" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 focus:ring-red-500 focus:border-red-500" min="1980" max="2099" />
                        </div>
                        <div>
                            <label for="mileage" class="block font-medium text-gray-700">Явсан (км) *</label>
                            <input type="number" id="mileage" name="mileage" placeholder="25255" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 focus:ring-red-500 focus:border-red-500" min="0" required />
                        </div>
                        <div>
                            <label for="price" class="block font-medium text-gray-700">Үнэ (сая ₮) *</label>
                            <input type="number" id="price" name="price" step="0.1" placeholder="10" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 focus:ring-red-500 focus:border-red-500" min="0.1" required />
                        </div>
                    </div>

                    <!-- More technical fields -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="condition" class="block font-medium text-gray-700">Нөхцөл</label>
                            <select id="condition" name="condition" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 focus:ring-red-500 focus:border-red-500">
                                <option value="">Сонгох</option>
                                <option value="Дугаар аваагүй">Дугаар аваагүй</option>
                                <option value="Дугаар авсан">Дугаар авсан</option>
                                <option value="Шинэ">Шинэ</option>
                                <option value="Хуучин">Хуучин</option>
                            </select>
                        </div>
                        <div>
                            <label for="bodyType" class="block font-medium text-gray-700">Төрөл</label>
                            <select id="bodyType" name="bodyType" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 focus:ring-red-500 focus:border-red-500">
                                <option value="">Сонгох</option>
                                <option value="Жийп">Жийп</option>
                                <option value="Седан">Седан</option>
                                <option value="Хэтчбек">Хэтчбек</option>
                                <option value="Пикап">Пикап</option>
                                <option value="Микро / Бус">Микро / Бус</option>
                                <option value="Бусад">Бусад</option>
                            </select>
                        </div>
                        <div>
                            <label for="doors" class="block font-medium text-gray-700">Хаалга</label>
                            <select id="doors" name="doors" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 focus:ring-red-500 focus:border-red-500">
                                <option value="">Сонгох</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="driveType" class="block font-medium text-gray-700">Хөтлөгч</label>
                            <select id="driveType" name="driveType" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 focus:ring-red-500 focus:border-red-500">
                                <option value="">Сонгох</option>
                                <option value="Урд">Урд</option>
                                <option value="Хойд">Хойд</option>
                                <option value="Бүх дугуй 4WD">Бүх дугуй 4WD</option>
                            </select>
                        </div>
                        <div>
                            <label for="transmission" class="block font-medium text-gray-700">Хурдны хайрцаг</label>
                            <select id="transmission" name="transmission" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 focus:ring-red-500 focus:border-red-500">
                                <option value="">Сонгох</option>
                                <option value="Механик">Механик</option>
                                <option value="Автомат">Автомат</option>
                                <option value="Автомат + Tiptronic">Автомат + Tiptronic</option>
                                <option value="CVT">CVT</option>
                            </select>
                        </div>
                        <div>
                            <label for="fuelType" class="block font-medium text-gray-700">Хөдөлгүүр (түлш)</label>
                            <select id="fuelType" name="fuelType" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 focus:ring-red-500 focus:border-red-500">
                                <option value="Бензин">Бензин</option>
                                <option value="Дизель">Дизель</option>
                                <option value="Бензин + Цахилгаан">Бензин + Цахилгаан</option>
                                <option value="Цахилгаан">Цахилгаан</option>
                                <option value="Хий">Хий</option>
                                <option value="Бусад">Бусад</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="engineVolume" class="block font-medium text-gray-700">Мотор багтаамж (л)</label>
                            <input type="text" id="engineVolume" name="engineVolume" placeholder="3.6" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 focus:ring-red-500 focus:border-red-500" />
                        </div>
                        <div>
                            <label for="exteriorColor" class="block font-medium text-gray-700">Гадна өнгө</label>
                            <input type="text" id="exteriorColor" name="exteriorColor" placeholder="Саарал" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 focus:ring-red-500 focus:border-red-500" />
                        </div>
                        <div>
                            <label for="interiorColor" class="block font-medium text-gray-700">Дотор өнгө</label>
                            <input type="text" id="interiorColor" name="interiorColor" placeholder="Хар, арьсан" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 focus:ring-red-500 focus:border-red-500" />
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="leasing" class="block font-medium text-gray-700">Лизинг</label>
                            <select id="leasing" name="leasing" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 focus:ring-red-500 focus:border-red-500">
                                <option value="">Сонгох</option>
                                <option value="Лизингтэй">Лизингтэй</option>
                                <option value="Лизинггүй">Лизинггүй</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="engine" class="block font-medium text-gray-700">Хөдөлгүүрийн нэмэлт тайлбар</label>
                            <input type="text" id="engine" name="engine" placeholder="V6, Hybrid, Turbo..." class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5 focus:ring-red-500 focus:border-red-500" />
                        </div>
                    </div>

                    <!-- Description -->
                    <div>
                        <label for="description" class="block font-medium text-gray-700">Тайлбар *</label>
                        <textarea id="description" name="description" rows="3" placeholder="Мотор, кроп асуудалгүй, хийц будагтай, бартер сонсоно..." class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:ring-red-500 focus:border-red-500" required></textarea>
                    </div>

                    <!-- Seller Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                        <div>
                            <label for="sellerName" class="block font-medium text-gray-700">Зар оруулагчийн нэр</label>
                            <input type="text" id="sellerName" name="sellerName" placeholder="Bambar Group, Бат..." class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:ring-red-500 focus:border-red-500" />
                        </div>
                        <div>
                            <label for="sellerPhone" class="block font-medium text-gray-700">Утасны дугаар</label>
                            <input type="tel" id="sellerPhone" name="sellerPhone" placeholder="99998877" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:ring-red-500 focus:border-red-500" />
                        </div>
                    </div>

                    <!-- Images -->
                    <div class="mt-4">
                        <label for="carImageFile" class="block text-sm font-medium text-gray-700 mb-1">Зурагнууд *</label>
                        <div class="flex items-center space-x-3">
                            <input type="file" id="carImageFile" name="carImageFile" multiple accept="image/jpeg,image/png,image/jpg" class="w-full block border border-gray-300 rounded-lg shadow-sm py-2 px-4 file:mr-4 file:py-1 file:px-2 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100 cursor-pointer" required />
                            <span id="file-count-display" class="text-sm text-gray-600 whitespace-nowrap">0 файл сонгосон</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">
                            Олон зураг оруулж болно. Зураг бүр автоматаар шахагдаж 1.8MB-с бага хэмжээгээр хадгалагдана.
                        </p>
                    </div>

                    <!-- AI Button -->
                    <div class="flex justify-between items-center space-x-4">
                        <button type="button" id="generate-description-btn" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 transition duration-150 flex items-center space-x-2 w-full justify-center">
                            <span id="ai-loading" class="hidden">
                                <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </span>
                            <span id="ai-text">Зар Тайлбар Үүсгэх ✨</span>
                        </button>
                    </div>

                    <!-- Submit -->
                    <button type="submit" id="submit-car-btn" class="w-full mt-2 bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-red-700 transition duration-150">
                        Зар Нэмэх
                    </button>
                </form>

                <!-- Alert -->
                <div id="custom-alert" class="hidden fixed bottom-4 right-4 bg-red-600 text-white p-4 rounded-lg shadow-xl max-w-sm z-30" role="alert">
                    <p class="font-bold">АЛДАА:</p>
                    <p id="alert-message" class="text-sm"></p>
                    <button onclick="document.getElementById('custom-alert').classList.add('hidden')" class="mt-2 text-xs opacity-80 hover:opacity-100">Хаах</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal (card дээр дарахад) -->
    <div id="car-detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden z-30 overflow-y-auto">
        <div class="min-h-screen flex items-start md:items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full md:h-[90vh] flex flex-col">
                <!-- Header -->
                <div class="flex justify-between items-center px-6 py-4 border-b">
                    <h2 id="detail-title" class="text-xl md:text-2xl font-bold text-gray-800">
                        Машины дэлгэрэнгүй
                    </h2>
                    <button id="detail-close-btn" class="text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto p-4 md:p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left: images -->
                        <div class="lg:col-span-2">
                            <div class="bg-gray-100 rounded-lg overflow-hidden flex items-center justify-center h-72 md:h-96">
                                <img id="detail-main-image" src="" alt="Car main" class="max-h-full w-full object-contain" />
                            </div>
                            <div id="detail-thumbs" class="mt-3 flex space-x-2 overflow-x-auto pb-1"></div>
                        </div>

                        <!-- Right: price & seller -->
                        <div class="space-y-4">
                            <div class="bg-yellow-100 border border-yellow-300 rounded-lg p-4">
                                <p class="text-sm text-gray-600">Үнэ</p>
                                <p id="detail-price" class="text-2xl md:text-3xl font-extrabold text-red-600">—</p>
                                <p id="detail-price-note" class="text-xs text-gray-500 mt-1">
                                    Үнэд бүх татвар, бусад зардал орсон эсэхийг зар оруулагчаас тодруулна уу.
                                </p>
                            </div>

                            <div class="bg-red-600 text-white rounded-lg p-4 space-y-2">
                                <p class="text-sm opacity-80">Холбоо барих</p>
                                <p id="detail-seller-name" class="text-lg font-bold">Мэдээлэлгүй</p>
                                <p id="detail-seller-phone" class="text-base font-semibold">
                                    Утас: —
                                </p>
                            </div>

                            <div class="bg-gray-50 rounded-lg p-4 text-sm text-gray-700">
                                <p class="font-semibold mb-1">Товч тайлбар</p>
                                <p id="detail-short-desc" class="text-sm leading-relaxed">—</p>
                            </div>
                        </div>
                    </div>

                    <!-- Specs table -->
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div class="space-y-1">
                            <p><span class="font-semibold">Үйлдвэрлэсэн он:</span> <span id="spec-year"></span></p>
                            <p><span class="font-semibold">Орж ирсэн он:</span> <span id="spec-importYear"></span></p>
                            <p><span class="font-semibold">Нөхцөл:</span> <span id="spec-condition"></span></p>
                            <p><span class="font-semibold">Төрөл:</span> <span id="spec-bodyType"></span></p>
                            <p><span class="font-semibold">Хаалга:</span> <span id="spec-doors"></span></p>
                            <p><span class="font-semibold">Явсан:</span> <span id="spec-mileage"></span></p>
                        </div>
                        <div class="space-y-1">
                            <p><span class="font-semibold">Хөдөлгүүр (түлш):</span> <span id="spec-fuelType"></span></p>
                            <p><span class="font-semibold">Мотор багтаамж:</span> <span id="spec-engineVolume"></span></p>
                            <p><span class="font-semibold">Хөтлөгч:</span> <span id="spec-driveType"></span></p>
                            <p><span class="font-semibold">Хурдны хайрцаг:</span> <span id="spec-transmission"></span></p>
                            <p><span class="font-semibold">Гадна өнгө:</span> <span id="spec-exteriorColor"></span></p>
                            <p><span class="font-semibold">Дотор өнгө:</span> <span id="spec-interiorColor"></span></p>
                            <p><span class="font-semibold">Лизинг:</span> <span id="spec-leasing"></span></p>
                        </div>
                    </div>

                    <!-- Long description -->
                    <div class="mt-6">
                        <p class="font-semibold text-sm mb-1">Дэлгэрэнгүй тайлбар</p>
                        <p id="detail-description" class="text-sm text-gray-800 leading-relaxed whitespace-pre-line"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JS -->
    <script>
        // --- Utility Functions (UI) ---
        function showCustomAlert(message) {
            const alertBox = document.getElementById("custom-alert");
            const alertMessage = document.getElementById("alert-message");
            alertMessage.textContent = message;
            alertBox.classList.remove("hidden", "bg-red-600", "bg-green-600");
            alertBox.classList.add("bg-red-600");
            setTimeout(() => alertBox.classList.add('hidden'), 5000); // Hide after 5 seconds
        }

        function showSuccessAlert(message) {
            const alertBox = document.getElementById("custom-alert");
            const alertMessage = document.getElementById("alert-message");
            alertMessage.textContent = message;
            alertBox.classList.remove("hidden", "bg-red-600", "bg-green-600");
            alertBox.classList.add("bg-green-600");
            setTimeout(() => alertBox.classList.add('hidden'), 5000); // Hide after 5 seconds
        }

        function formatNumber(num) {
            if (num === null || num === undefined || num === "") return "—";
            if (isNaN(num)) return num;
            // Ensure number is treated as fixed point for formatting before comma separation
            return new Intl.NumberFormat("en-US", { maximumFractionDigits: 1 }).format(num);
        }
        
        // --- Modal Functions (Global Scope) ---
        function openModal() {
            document.getElementById("add-car-modal").classList.remove("hidden");
            const form = document.getElementById("add-car-form");
            if (form) form.reset();
        }

        function closeModal() {
            document.getElementById("add-car-modal").classList.add("hidden");
            const form = document.getElementById("add-car-form");
            if (form) form.reset();
            const fileDisplay = document.getElementById("file-count-display");
            if (fileDisplay) fileDisplay.textContent = "0 файл сонгосон";
        }
        
        function closeDetailModal() {
            const modal = document.getElementById("car-detail-modal");
            if (modal) modal.classList.add("hidden");
        }


        // Resizes and converts image file(s) to Base64 string(s)
        function fileToBase64(files) {
            return new Promise((resolve, reject) => {
                const results = [];
                let filesProcessed = 0;

                if (!files || files.length === 0) {
                    resolve([]);
                    return;
                }

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (file.size > 1.8 * 1024 * 1024) { 
                        reject(new Error(`Файлын хэмжээ хэтэрхий том (${(file.size / 1024 / 1024).toFixed(2)}MB). 1.8MB-аас бага байх ёстой.`));
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement("canvas");
                            const MAX_WIDTH = 900;
                            let width = img.width;
                            let height = img.height;

                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                            canvas.width = width;
                            canvas.height = height;

                            const ctx = canvas.getContext("2d");
                            ctx.drawImage(img, 0, 0, width, height);

                            // Compress to JPEG for smaller file size (0.8 quality)
                            const dataURL = canvas.toDataURL("image/jpeg", 0.8);
                            results.push(dataURL);

                            filesProcessed++;
                            if (filesProcessed === files.length) {
                                resolve(results);
                            }
                        };
                        img.src = e.target.result;
                    };
                    reader.onerror = (error) => reject(error);
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // --- Data Handling (LocalStorage Emulation) ---

        const STORAGE_KEY = "carsmongolia_cars";
        let allCars = [];

        function loadCarsFromStorage() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return [];
                const arr = JSON.parse(raw);
                return Array.isArray(arr) ? arr : [];
            } catch (e) {
                console.error("localStorage parse error: Data corruption detected, resetting.", e);
                return []; // Return empty array on corruption
            }
        }

        function saveCarsToStorage(cars) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(cars));
            } catch (e) {
                console.error("localStorage save error:", e);
                showCustomAlert("Алдаа: Зар хадгалах боломжгүй (Хөтчийн санах ой дүүрсэн байж магадгүй).");
            }
        }

        // --- Filter Management ---

        let selectedManufacturer = "all";
        let selectedModel = "all";
        let yearMin = null;
        let yearMax = null;
        let priceMin = null;
        let priceMax = null;

        function updateFilterOptions() {
            const manSelect = document.getElementById("filter-manufacturer");
            const modelSelect = document.getElementById("filter-model");
            if (!manSelect || !modelSelect) return;

            const manufacturers = [
                ...new Set(
                    allCars
                        .map((c) => (c.manufacturer || "").trim())
                        .filter((x) => x)
                ),
            ].sort((a, b) => a.localeCompare(b, "mn"));

            const prevMan = selectedManufacturer;

            manSelect.innerHTML = "";
            manSelect.appendChild(new Option("Бүх үйлдвэрлэгч", "all"));

            manufacturers.forEach((m) => {
                manSelect.appendChild(new Option(m, m));
            });

            // Restore previous manufacturer selection or reset
            if (prevMan && manufacturers.includes(prevMan)) {
                manSelect.value = prevMan;
                selectedManufacturer = prevMan;
            } else {
                 manSelect.value = "all";
                 selectedManufacturer = "all";
            }
            
            // Update models based on selected manufacturer
            const modelSource =
                selectedManufacturer === "all"
                    ? allCars
                    : allCars.filter((c) => c.manufacturer === selectedManufacturer);

            const models = [
                ...new Set(
                    modelSource
                        .map((c) => (c.model || "").trim())
                        .filter((x) => x)
                ),
            ].sort((a, b) => a.localeCompare(b, "mn"));

            const prevModel = selectedModel;

            modelSelect.innerHTML = "";
            modelSelect.appendChild(new Option("Бүх модель", "all"));

            models.forEach((m) => {
                modelSelect.appendChild(new Option(m, m));
            });

            // Restore previous model selection or reset
            if (prevModel && models.includes(prevModel)) {
                modelSelect.value = prevModel;
                selectedModel = prevModel;
            } else {
                modelSelect.value = "all";
                selectedModel = "all";
            }
        }

        // --- Detail Modal Logic ---

        function openDetailModal(car) {
            const modal = document.getElementById("car-detail-modal");
            if (!modal) return;
            
            // Set fields, using || '—' for safety
            document.getElementById("detail-title").textContent =
                (car.manufacturer || "—") + " " + (car.model || "—");
            document.getElementById("detail-price").textContent =
                formatNumber(car.price) + " сая ₮";
            document.getElementById("detail-seller-name").textContent =
                car.sellerName || "Мэдээлэлгүй";
            document.getElementById("detail-seller-phone").textContent =
                "Утас: " + (car.sellerPhone || "—");
            document.getElementById("detail-short-desc").textContent =
                (car.description || "—").split("\n")[0];
            document.getElementById("detail-description").textContent =
                car.description || "—";
            
            // Specs
            document.getElementById("spec-year").textContent = car.year || "—";
            document.getElementById("spec-importYear").textContent = car.importYear || "—";
            document.getElementById("spec-condition").textContent = car.condition || "—";
            document.getElementById("spec-bodyType").textContent = car.bodyType || "—";
            document.getElementById("spec-doors").textContent = car.doors || "—";
            document.getElementById("spec-mileage").textContent = formatNumber(car.mileage) + " км";
            document.getElementById("spec-fuelType").textContent = car.fuelType || "—";
            document.getElementById("spec-engineVolume").textContent = car.engineVolume ? car.engineVolume + " л" : "—";
            document.getElementById("spec-driveType").textContent = car.driveType || "—";
            document.getElementById("spec-transmission").textContent = car.transmission || "—";
            document.getElementById("spec-exteriorColor").textContent = car.exteriorColor || "—";
            document.getElementById("spec-interiorColor").textContent = car.interiorColor || "—";
            document.getElementById("spec-leasing").textContent = car.leasing || "—";

            // Images logic
            const mainImg = document.getElementById("detail-main-image");
            const thumbsContainer = document.getElementById("detail-thumbs");
            thumbsContainer.innerHTML = "";

            const imgs = car.imageDatas && car.imageDatas.length ? car.imageDatas : [];
            if (imgs.length) {
                mainImg.src = imgs[0];
            } else {
                mainImg.src = "";
            }

            imgs.forEach((src, idx) => {
                const img = document.createElement("img");
                img.src = src;
                img.alt = "thumb " + (idx + 1);
                img.className = "h-16 w-20 object-cover rounded cursor-pointer border border-gray-300";
                if (idx === 0) img.classList.add("thumb-active");
                img.addEventListener("click", () => {
                    mainImg.src = src;
                    Array.from(thumbsContainer.children).forEach((child) =>
                        child.classList.remove("thumb-active")
                    );
                    img.classList.add("thumb-active");
                });
                thumbsContainer.appendChild(img);
            });

            modal.classList.remove("hidden");
        }

        function closeDetailModal() {
            const modal = document.getElementById("car-detail-modal");
            if (modal) modal.classList.add("hidden");
        }

        // --- Main Rendering (Including Image Slider Logic) ---
        
        // This array will hold the current image index for each car card being rendered
        const cardImageIndices = {};

        function updateCardImage(cardId, car, newIndex) {
            const imgElement = document.getElementById(`card-img-${cardId}`);
            if (imgElement && car.imageDatas && car.imageDatas.length > 0) {
                imgElement.src = car.imageDatas[newIndex];
                cardImageIndices[cardId] = newIndex;
            }
        }

        function renderCarListings() {
            const container = document.getElementById("listings-container");
            container.innerHTML = "";

            const filteredCars = allCars.filter((car) => {
                const y = Number(car.year);
                const p = Number(car.price);
                
                // 1. Manufacturer/Model filter
                if (selectedManufacturer !== "all" && car.manufacturer !== selectedManufacturer)
                    return false;

                if (selectedModel !== "all" && car.model !== selectedModel)
                    return false;

                // 2. Range filters (Year and Price)
                if (yearMin !== null && !isNaN(yearMin) && y < yearMin) return false;
                if (yearMax !== null && !isNaN(yearMax) && y > yearMax) return false;

                if (priceMin !== null && !isNaN(priceMin) && p < priceMin) return false;
                if (priceMax !== null && !isNaN(priceMax) && p > priceMax) return false;

                return true;
            });

            if (filteredCars.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-10 text-gray-500 font-semibold text-lg">
                    Одоогоор ${
                        selectedManufacturer === "all" &&
                        selectedModel === "all" &&
                        yearMin === null &&
                        yearMax === null &&
                        priceMin === null &&
                        priceMax === null
                            ? "машины зар байхгүй"
                            : "шүүлтүүрээр тохирох зар олдсонгүй"
                    }.
                </div>`;
                return;
            }

            filteredCars.forEach((car, index) => {
                const carId = car.id || `car-${index}`; // Ensure car has an ID for tracking
                
                // Initialize or retrieve current image index
                const currentImageIndex = cardImageIndices[carId] || 0;
                cardImageIndices[carId] = currentImageIndex;

                const firstImage =
                    car.imageDatas && car.imageDatas.length > 0
                        ? car.imageDatas[currentImageIndex]
                        : "";
                const imageCount = car.imageDatas ? car.imageDatas.length : 0;

                const card = document.createElement("div");
                card.className =
                    "bg-white rounded-xl shadow-lg overflow-hidden transition duration-300 hover:shadow-xl transform hover:-translate-y-1 cursor-pointer";
                
                // Attach detail modal opener to the card itself (excluding image buttons)
                card.onclick = (e) => {
                    // Prevent detail modal opening when clicking slider buttons
                    if (!e.target.closest('.slider-btn')) {
                        openDetailModal(car);
                    }
                };

                card.innerHTML = `
                    <div class="relative h-56 bg-gray-200 overflow-hidden">
                        ${
                            firstImage
                                ? `<img id="card-img-${carId}" src="${firstImage}" alt="${car.manufacturer} ${car.model}" class="w-full h-full object-cover transition-opacity duration-300">`
                                : `<div class="w-full h-full flex items-center justify-center text-gray-500 text-lg font-bold">Зураг Олдсонгүй</div>`
                        }
                        
                        <!-- Slider Buttons -->
                        ${
                            imageCount > 1
                            ? `
                            <button id="prev-btn-${carId}" class="slider-btn absolute top-1/2 left-2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 transition" data-action="prev" data-car-id="${carId}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                            </button>
                            <button id="next-btn-${carId}" class="slider-btn absolute top-1/2 right-2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 transition" data-action="next" data-car-id="${carId}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                            </button>
                            `
                            : ''
                        }

                        <div class="absolute top-3 right-3 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full shadow-md">
                            ${car.fuelType || "—"}
                        </div>
                        ${
                            imageCount > 0
                            ? `<div id="count-${carId}" class="absolute bottom-3 left-3 bg-black bg-opacity-60 text-white text-xs font-medium px-2 py-1 rounded-full">Зураг ${currentImageIndex + 1}/${imageCount}</div>`
                            : ""
                        }
                    </div>
                    <div class="p-5 space-y-2">
                        <h3 class="text-xl font-bold text-gray-900">
                            ${(car.manufacturer || "") + " " + (car.model || "")}
                        </h3>
                        <div class="flex flex-wrap text-xs md:text-sm text-gray-600 space-x-4">
                            <p><strong>Он:</strong> ${car.year || "—"}</p>
                            <p><strong>Явсан:</strong> ${formatNumber(car.mileage)} км</p>
                        </div>
                        <p class="text-2xl md:text-3xl font-extrabold text-red-600 border-t pt-2">
                            ${formatNumber(car.price)} сая ₮
                        </p>
                        <p class="text-xs text-gray-700 mt-1 line-clamp-2">
                            ${car.description || ""}
                        </p>
                    </div>
                `;
                
                container.appendChild(card);
                
                // Add event listeners for the slider buttons immediately after rendering the card
                if (imageCount > 1) {
                    const nextBtn = document.getElementById(`next-btn-${carId}`);
                    const prevBtn = document.getElementById(`prev-btn-${carId}`);
                    const countDisplay = document.getElementById(`count-${carId}`);

                    const handleSliderClick = (action) => {
                        let currentIndex = cardImageIndices[carId];
                        let newIndex = currentIndex;

                        if (action === 'next') {
                            newIndex = (currentIndex + 1) % imageCount;
                        } else if (action === 'prev') {
                            newIndex = (currentIndex - 1 + imageCount) % imageCount;
                        }
                        
                        updateCardImage(carId, car, newIndex);
                        countDisplay.textContent = `Зураг ${newIndex + 1}/${imageCount}`;
                    };

                    if (nextBtn) nextBtn.addEventListener('click', (e) => {
                         e.stopPropagation(); // Stop card click event
                         handleSliderClick('next');
                    });
                    if (prevBtn) prevBtn.addEventListener('click', (e) => {
                         e.stopPropagation(); // Stop card click event
                         handleSliderClick('prev');
                    });
                }
            });
        }

        // --- Gemini API Handler ---
        async function generateDescription() {
            // ... (Gemini API logic remains the same)
            const manufacturer = document.getElementById("manufacturer").value.trim();
            const model = document.getElementById("model").value.trim();
            const year = document.getElementById("year").value.trim();
            const mileage = document.getElementById("mileage").value.trim();
            const price = document.getElementById("price").value.trim();
            const descriptionField = document.getElementById("description");
            const loadingIndicator = document.getElementById("ai-loading");
            const aiTextSpan = document.getElementById("ai-text");
            const generateDescBtn = document.getElementById("generate-description-btn");

            if (!manufacturer || !model || !year || !price) {
                showCustomAlert("Тайлбар үүсгэхийн тулд Үйлдвэрлэгч, Модель, Үйлдвэрлэсэн он, Үнийг бөглөнө үү.");
                return;
            }

            // Set loading state
            loadingIndicator.classList.remove("hidden");
            aiTextSpan.textContent = "Үүсгэж байна...";
            generateDescBtn.disabled = true;

            const userPrompt = `Машин зарах зарны сэтгэл татам, мэргэжлийн түвшний тайлбарыг Монгол хэлээр бичээд өгнө үү.
            Үйлдвэрлэгч: ${manufacturer}, Модель: ${model}, Үйлдвэрлэсэн он: ${year}, Гүйлтийн зай: ${formatNumber(
                mileage
            )} км, Үнэ: ${formatNumber(price)} сая төгрөг. Зөвхөн тайлбар бичиж гаргана уу.`;
            
            // NOTE: LLM_API_KEY is not defined in this localStorage version. Assuming it is available in the environment.
            const LLM_API_KEY = ""; 

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${LLM_API_KEY}`;

                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: {
                        parts: [
                            {
                                text: "Act as a professional car sales copywriter for the Mongolian market. Generate a compelling, detailed, and polite sales description.",
                            },
                        ],
                    },
                };

                const response = await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    const errorJson = await response.json();
                    throw new Error(`API дуудлагын алдаа: ${errorJson.error?.message || response.statusText}`);
                }

                const result = await response.json();
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Тайлбар үүсгэх боломжгүй.";

                descriptionField.value = generatedText.trim();
                showSuccessAlert("Тайлбар амжилттай үүсгэгдлээ!");
            } catch (error) {
                showCustomAlert(`Gemini API алдаа: ${error.message}. (API key шалгана уу).`);
                console.error("Gemini API Error:", error);
            } finally {
                loadingIndicator.classList.add("hidden");
                aiTextSpan.textContent = "Зар Тайлбар Үүсгэх ✨";
                generateDescBtn.disabled = false;
            }
        }


        // --- Event Listeners and Initial Load ---
        document.addEventListener("DOMContentLoaded", () => {
            allCars = loadCarsFromStorage();
            const loadingMessage = document.getElementById("loading-message");
            if (loadingMessage) loadingMessage.classList.add("hidden");
            
            // --- Initial UI Load ---
            updateFilterOptions();
            renderCarListings();

            const form = document.getElementById("add-car-form");
            const openModalBtn = document.getElementById("open-modal-btn");
            const closeModalBtn = document.getElementById("close-modal-btn");
            const modalOverlay = document.getElementById("add-car-modal");
            const carImageFile = document.getElementById("carImageFile");
            const fileCountDisplay = document.getElementById("file-count-display");
            const generateDescBtn = document.getElementById("generate-description-btn");

            // Attach modal listeners (FIX APPLIED: openModal is not defined)
            if (openModalBtn) openModalBtn.addEventListener("click", function() { openModal(); }); 
            if (closeModalBtn) closeModalBtn.addEventListener("click", function() { closeModal(); }); 
            
            if (modalOverlay)
                modalOverlay.addEventListener("click", (e) => {
                    if (e.target.id === "add-car-modal") {
                        closeModal();
                    }
                });

            const detailModal = document.getElementById("car-detail-modal");
            const detailCloseBtn = document.getElementById("detail-close-btn");
            if (detailModal)
                detailModal.addEventListener("click", (e) => {
                    if (e.target.id === "car-detail-modal") {
                        closeDetailModal();
                    }
                });
            if (detailCloseBtn) detailCloseBtn.addEventListener("click", closeDetailModal);

            // File input listener to update count
            if (carImageFile) {
                carImageFile.addEventListener("change", () => {
                    const count = carImageFile.files.length;
                    fileCountDisplay.textContent = count + " файл сонгосон";
                });
            }

            // Filter listeners (Simplified logic using input events)
            const inputsToFilter = [
                "filter-manufacturer", "filter-model", "filter-year-min", "filter-year-max",
                "filter-price-min", "filter-price-max"
            ];

            inputsToFilter.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener(element.tagName === 'SELECT' ? 'change' : 'input', (e) => {
                        const val = e.target.value;
                        
                        if (id === "filter-manufacturer") {
                            selectedManufacturer = val;
                            updateFilterOptions(); // Re-render model options
                        } else if (id === "filter-model") {
                            selectedModel = val;
                        } else if (id === "filter-year-min") {
                            yearMin = val ? Number(val) : null;
                        } else if (id === "filter-year-max") {
                            yearMax = val ? Number(val) : null;
                        } else if (id === "filter-price-min") {
                            priceMin = val ? Number(val) : null;
                        } else if (id === "filter-price-max") {
                            priceMax = val ? Number(val) : null;
                        }
                        
                        renderCarListings();
                    });
                }
            });
            
            // Clear Filters Button
            const clearFiltersBtn = document.getElementById("clear-filters");
            if (clearFiltersBtn) {
                 clearFiltersBtn.addEventListener("click", () => {
                    selectedManufacturer = "all";
                    selectedModel = "all";
                    yearMin = null;
                    yearMax = null;
                    priceMin = null;
                    priceMax = null;

                    document.getElementById("filter-manufacturer").value = "all";
                    document.getElementById("filter-model").value = "all";
                    document.getElementById("filter-year-min").value = "";
                    document.getElementById("filter-year-max").value = "";
                    document.getElementById("filter-price-min").value = "";
                    document.getElementById("filter-price-max").value = "";

                    updateFilterOptions();
                    renderCarListings();
                });
            }

            // Form submission logic
            if (form) {
                form.addEventListener("submit", async (e) => {
                    e.preventDefault();

                    const submitBtn = document.getElementById("submit-car-btn");
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Зургийг боловсруулж байна...'; // FIX: More detailed loading message

                    const data = new FormData(form);
                    const files = carImageFile.files;

                    if (!files || files.length === 0) {
                        showCustomAlert("Зургаа заавал оруулна уу.");
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Зар Нэмэх';
                        return;
                    }

                    try {
                        // 1. Process images (Base64 conversion and compression)
                        const imageDatas = await fileToBase64(files);

                        // 2. Prepare data object
                        const carData = {
                            id: Date.now().toString() + "-" + Math.random().toString(36).slice(2), // Generate unique ID
                            manufacturer: (data.get("manufacturer") || "").trim(),
                            model: (data.get("model") || "").trim(),
                            year: Number(data.get("year")),
                            importYear: data.get("importYear") ? Number(data.get("importYear")) : "",
                            mileage: Number(data.get("mileage")),
                            price: Number(data.get("price")),
                            condition: data.get("condition") || "",
                            bodyType: data.get("bodyType") || "",
                            doors: data.get("doors") || "",
                            driveType: data.get("driveType") || "",
                            transmission: data.get("transmission") || "",
                            fuelType: data.get("fuelType") || "",
                            engineVolume: (data.get("engineVolume") || "").trim(),
                            exteriorColor: (data.get("exteriorColor") || "").trim(),
                            interiorColor: (data.get("interiorColor") || "").trim(),
                            leasing: data.get("leasing") || "",
                            engine: (data.get("engine") || "").trim(),
                            description: (data.get("description") || "").trim(),
                            sellerName: (data.get("sellerName") || "").trim(),
                            sellerPhone: (data.get("sellerPhone") || "").trim(),
                            imageDatas,
                            createdAt: new Date().toISOString(),
                        };
                        
                        submitBtn.textContent = 'Хадгалж байна...'; // Change message after image processing

                        // 3. Save to localStorage
                        allCars.unshift(carData);
                        saveCarsToStorage(allCars);
                        
                        // 4. Update UI
                        updateFilterOptions();
                        renderCarListings();
                        showSuccessAlert("Машины зар амжилттай нэмэгдлээ!");
                        closeModal();

                    } catch (error) {
                        showCustomAlert(`Зургийг боловсруулах/хадгалах алдаа: ${error.message}`);
                        console.error("Save Error:", error);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Зар Нэмэх';
                    }
                });
            }

            // Gemini API Handler (If needed later)
            if (generateDescBtn) {
                // Attach click listener to the global function
                generateDescBtn.addEventListener('click', generateDescription);
            }
        });
    </script>
</body>
</html>
