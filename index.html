<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <title>CarsMongolia.mn – Машин Зар Оруулах</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui,-apple-system,BlinkMacSystemFont,"Inter","Segoe UI",sans-serif; background-color:#f3f4f6; }
  </style>
</head>
<body class="min-h-screen bg-gray-100">
  <!-- HEADER -->
  <header class="bg-white shadow sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-2xl font-bold text-red-600">CarsMongolia.mn</h1>
      <button id="open-modal-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold shadow hover:bg-red-700 flex items-center gap-2">
        <span class="text-xl leading-none">＋</span><span>Зар Оруулах</span>
      </button>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto px-4 py-8">
    <div class="border-2 border-dashed border-gray-300 rounded-xl bg-white p-8 text-center text-gray-500">
      Энд дараагийн алхам дээр машины жагсаалт гарна. Одоохондоо <span class="font-semibold">“Зар Оруулах”</span> л ажиллана.
    </div>
  </main>

  <!-- MODAL -->
  <div id="add-car-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-20 overflow-y-auto">
    <div class="min-h-screen flex items-start justify-center px-4 py-8">
      <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full relative p-6 md:p-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold text-gray-900">Машины Зар Оруулах</h2>
          <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">×</button>
        </div>

        <p class="text-xs text-gray-500 mb-4">
          * тэмдэгтэй талбарууд заавал. Зургууд Storage-д, мэдээлэл Firestore-д хадгалагдана.
        </p>

        <form id="add-car-form" class="space-y-6">
          <!-- 1. ҮНДСЭН -->
          <div>
            <h3 class="text-lg font-semibold mb-2 text-gray-800">1. Машины үндсэн мэдээлэл</h3>
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label for="manufacturer" class="block text-sm font-medium text-gray-700">Үйлдвэрлэгч *</label>
                <select id="manufacturer" name="manufacturer" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500" required>
                  <option value="">Сонгох</option>
                </select>
              </div>
              <div>
                <label for="model" class="block text-sm font-medium text-gray-700">Модель *</label>
                <select id="model" name="model" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500" required>
                  <option value="">Эхлээд үйлдвэрлэгч</option>
                </select>
              </div>
              <div>
                <label for="year" class="block text-sm font-medium text-gray-700">Үйлдвэрлэсэн он *</label>
                <input type="number" id="year" name="year" min="1980" max="2099" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500" required />
              </div>
              <div>
                <label for="importYear" class="block text-sm font-medium text-gray-700">Орж ирсэн он</label>
                <input type="number" id="importYear" name="importYear" min="1980" max="2099" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300" />
              </div>
            </div>

            <div class="grid md:grid-cols-3 gap-4 mt-4">
              <div>
                <label for="condition" class="block text-sm font-medium text-gray-700">Нөхцөл *</label>
                <select id="condition" name="condition" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500" required>
                  <option value="Дугаар аваагүй">Дугаар аваагүй</option>
                  <option value="Дугаар авсан">Дугаар авсан</option>
                  <option value="Шинэ">Шинэ</option>
                  <option value="Хуучин">Хуучин</option>
                </select>
              </div>
              <div>
                <label for="bodyType" class="block text-sm font-medium text-gray-700">Төрөл</label>
                <select id="bodyType" name="bodyType" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300">
                  <option value="">Сонгох</option><option>Суудлын</option><option>Жийп</option><option>Микро</option><option>Ачааны</option><option>Бусад</option>
                </select>
              </div>
              <div>
                <label for="doors" class="block text-sm font-medium text-gray-700">Хаалга</label>
                <select id="doors" name="doors" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300">
                  <option value="">Сонгох</option><option>2</option><option>3</option><option>4</option><option>5</option>
                </select>
              </div>
            </div>
          </div>

          <!-- 2. ТЕХНИК -->
          <div>
            <h3 class="text-lg font-semibold mb-2 text-gray-800">2. Техникийн үзүүлэлт</h3>
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label for="mileage" class="block text-sm font-medium text-gray-700">Гүйлт (км) *</label>
                <input type="number" id="mileage" name="mileage" min="0" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500" required />
              </div>
              <div>
                <label for="price" class="block text-sm font-medium text-gray-700">Үнэ (сая ₮) *</label>
                <input type="number" id="price" name="price" step="0.1" min="0.1" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500" required />
              </div>
              <div>
                <label for="fuelType" class="block text-sm font-medium text-gray-700">Түлш *</label>
                <select id="fuelType" name="fuelType" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500" required>
                  <option>Бензин</option><option>Дизель</option><option>Хибрид</option><option>Цахилгаан</option><option>Хий</option><option>Бусад</option>
                </select>
              </div>
              <div>
                <label for="driveType" class="block text-sm font-medium text-gray-700">Хөтлөгч</label>
                <select id="driveType" name="driveType" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300">
                  <option value="">Сонгох</option><option>Урд</option><option>Хойд</option><option>Бүх дугуй 4WD</option>
                </select>
              </div>
              <div>
                <label for="transmission" class="block text-sm font-medium text-gray-700">Хурдны хайрцаг</label>
                <select id="transmission" name="transmission" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300">
                  <option value="">Сонгох</option><option>Автомат</option><option>Механик</option><option>Хос сцепление</option>
                </select>
              </div>
              <div>
                <label for="engineVolume" class="block text-sm font-medium text-gray-700">Мотор багтаамж (л)</label>
                <input type="text" id="engineVolume" name="engineVolume" placeholder="Жишээ: 2.4" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300" />
              </div>
            </div>

            <div class="grid md:grid-cols-3 gap-4 mt-4">
              <div>
                <label for="exteriorColor" class="block text-sm font-medium text-gray-700">Гадна өнгө</label>
                <input type="text" id="exteriorColor" name="exteriorColor" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300" />
              </div>
              <div>
                <label for="interiorColor" class="block text-sm font-medium text-gray-700">Дотор өнгө</label>
                <input type="text" id="interiorColor" name="interiorColor" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300" />
              </div>
              <div>
                <label for="leasing" class="block text-sm font-medium text-gray-700">Лизинг</label>
                <select id="leasing" name="leasing" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300">
                  <option>Лизинггүй</option><option>Лизингтэй</option>
                </select>
              </div>
            </div>
          </div>

          <!-- 3. ЗУРАГ -->
          <div>
            <h3 class="text-lg font-semibold mb-2 text-gray-800">3. Зураг, видео</h3>
            <div class="space-y-3">
              <div>
                <label for="carImages" class="block text-sm font-medium text-gray-700">Зурагнууд (олон сонгож болно) *</label>
                <input type="file" id="carImages" name="carImages" accept="image/*" multiple class="mt-1 w-full text-sm" required />
                <p id="file-count-display" class="text-xs text-gray-500 mt-1">Одоогоор зураг сонгоогүй байна.</p>
                <p class="text-xs text-gray-400">Нэг зураг 2MB-аас бага байхыг зөвлөе.</p>
              </div>
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label for="youtubeUrl" class="block text-sm font-medium text-gray-700">YouTube URL</label>
                  <input type="url" id="youtubeUrl" name="youtubeUrl" placeholder="https://www.youtube.com/..." class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300" />
                </div>
                <div>
                  <label for="tiktokUrl" class="block text-sm font-medium text-gray-700">TikTok линк</label>
                  <input type="url" id="tiktokUrl" name="tiktokUrl" placeholder="https://www.tiktok.com/..." class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300" />
                </div>
              </div>
            </div>
          </div>

          <!-- 4. ТАЙЛБАР -->
          <div>
            <h3 class="text-lg font-semibold mb-2 text-gray-800">4. Зарын тайлбар</h3>
            <textarea id="description" name="description" rows="4" class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Дэлгэрэнгүй тайлбарлана уу." required></textarea>
          </div>

          <!-- 5. ХОЛБОО -->
          <div>
            <h3 class="text-lg font-semibold mb-2 text-gray-800">5. Зар оруулагчийн мэдээлэл</h3>
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label for="sellerName" class="block text-sm font-medium text-gray-700">Нэр / Дэлгүүр *</label>
                <input type="text" id="sellerName" name="sellerName" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500" required />
              </div>
              <div>
                <label for="sellerEmail" class="block text-sm font-medium text-gray-700">Имэйл</label>
                <input type="email" id="sellerEmail" name="sellerEmail" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300" />
              </div>
              <div>
                <label for="sellerPhone" class="block text-sm font-medium text-gray-700">Утас *</label>
                <input type="tel" id="sellerPhone" name="sellerPhone" placeholder="+97699998888" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500" required />
              </div>
              <div>
                <span class="block text-sm font-medium text-gray-700 mb-1">Холбогдох сувгууд</span>
                <label class="inline-flex items-center mr-4 text-sm"><input type="checkbox" name="messengerWhatsapp" class="mr-1" />Whatsapp</label>
                <label class="inline-flex items-center mr-4 text-sm"><input type="checkbox" name="messengerTelegram" class="mr-1" />Telegram</label>
                <label class="inline-flex items-center text-sm"><input type="checkbox" name="messengerFacebook" class="mr-1" />Facebook Messenger</label>
              </div>
            </div>
          </div>

          <div class="pt-2 flex items-center justify-between gap-4">
            <p id="auth-status" class="text-xs text-gray-500">Firebase-д холбогдож байна...</p>
            <button type="submit" id="submit-car-btn" class="bg-red-600 text-white px-6 py-2.5 rounded-lg font-semibold shadow hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Зар Нэмэх</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- alert box -->
  <div id="custom-alert" class="hidden fixed bottom-4 right-4 max-w-sm text-white rounded-xl shadow-xl p-4 text-sm z-30 bg-red-600">
    <p class="font-bold mb-1" id="alert-title">АЛДАА</p>
    <p id="alert-message"></p>
    <button onclick="document.getElementById('custom-alert').classList.add('hidden')" class="mt-2 text-xs underline">Хаах</button>
  </div>

  <!-- FIREBASE + APP LOGIC -->
  <script type="module">
    // --- CAR DATA ---
    const CAR_DATA = {
      Toyota:["Prius","Prius Alpha","Aqua","Alphard","Crown","Camry","Harrier","CHR","RAV4","Land Cruiser 200","Land Cruiser 300","Fielder"],
      Lexus:["RX350","RX450h","NX300h","ES300h","GX460","LX570"],
      Honda:["Fit","Vezel","CR-V","Stepwgn","Odyssey","Accord","Shuttle"],
      Hyundai:["Sonata","Avante","Tucson","Santa Fe","Palisade","Staria"],
      Kia:["Sorento","Sportage","Carnival","K5","K7","Bongo3"],
      "Mercedes-Benz":["C200","E200","S350","GLC250","GLS400"],
      BMW:["320i","520i","740Li","X3","X5"],
      Audi:["A4","A6","A8","Q5","Q7"], Nissan:["X-Trail","Serena","Note","Cube","Elgrand"],
      Subaru:["Forester","Legacy","Outback","Impreza"], Volkswagen:["Golf","Passat","Tiguan"],
      Mazda:["Axela","Atenza","CX-5","CX-8"], Chevrolet:["Cruze","Volt","Camaro"],
      Ford:["Focus","Explorer","Mustang"], Jeep:["Compass","Cherokee","Wrangler"],
      Tesla:["Model S","Model 3","Model X","Model Y"]
    };
    const manufacturerSelect = document.getElementById("manufacturer");
    const modelSelect = document.getElementById("model");
    function populateManufacturers(){ Object.keys(CAR_DATA).sort((a,b)=>a.localeCompare(b,"mn")).forEach(b=>{const o=document.createElement("option");o.value=b;o.textContent=b;manufacturerSelect.appendChild(o);});}
    function populateModels(brand){ modelSelect.innerHTML=""; if(!brand||!CAR_DATA[brand]){const o=document.createElement("option");o.value="";o.textContent="Эхлээд үйлдвэрлэгч";modelSelect.appendChild(o);return;} CAR_DATA[brand].forEach(m=>{const o=document.createElement("option");o.value=m;o.textContent=m;modelSelect.appendChild(o);});}
    manufacturerSelect.addEventListener("change",()=>populateModels(manufacturerSelect.value));
    populateManufacturers();

    // --- Firebase v10 (тогтвортой) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAEW1YnJ_xm_YnPzW9y1iSmdQIrgOsfjlA",
      authDomain: "carsmongolia-d410a.firebaseapp.com",
      projectId: "carsmongolia-d410a",
      storageBucket: "carsmongolia-d410a.appspot.com",
      messagingSenderId: "483533885994",
      appId: "1:483533885994:web:e6718b4668f1896cf32953",
      measurementId: "G-8BR11G8E5Z"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentUserId = null;
    const submitBtn = document.getElementById("submit-car-btn");
    const authStatus = document.getElementById("auth-status");

    function showAlert(message, type="error"){
      const box=document.getElementById("custom-alert");
      const msg=document.getElementById("alert-message");
      const title=document.getElementById("alert-title");
      msg.textContent=message;
      title.textContent= type==="success" ? "АМЖИЛТ" : "АЛДАА";
      box.classList.remove("hidden","bg-red-600","bg-green-600");
      box.classList.add(type==="success" ? "bg-green-600" : "bg-red-600");
    }

    const ensureAuthReady = new Promise((resolve)=>{
      onAuthStateChanged(auth, async (user)=>{
        if(!user){
          try{ await signInAnonymously(auth); }catch(e){ console.error(e); showAlert("Firebase нэвтрэлт амжилтгүй: "+e.message); authStatus.textContent="Нэвтрэлт амжилтгүй."; return; }
          return; // дараагийн state_changed-т ороод resolve хийнэ
        }
        currentUserId = user.uid;
        submitBtn.disabled = false;
        authStatus.textContent = "Firebase-т нэвтэрсэн. Зар оруулж болно.";
        resolve();
      });
    });

    // --- MODAL UI ---
    const modal = document.getElementById("add-car-modal");
    const openBtn = document.getElementById("open-modal-btn");
    const closeBtn = document.getElementById("close-modal-btn");
    const form = document.getElementById("add-car-form");
    const fileInput = document.getElementById("carImages");
    const fileCountDisplay = document.getElementById("file-count-display");

    openBtn.addEventListener("click",()=>modal.classList.remove("hidden"));
    closeBtn.addEventListener("click",()=>modal.classList.add("hidden"));
    modal.addEventListener("click",(e)=>{ if(e.target===modal) modal.classList.add("hidden"); });
    fileInput.addEventListener("change",()=>{ const c=fileInput.files.length; fileCountDisplay.textContent= c===0 ? "Одоогоор зураг сонгоогүй байна." : `${c} файл сонгосон`; });

    // --- Helpers ---
    function withTimeout(promise, ms, msg="Сүлжээ удаан байна. Дахин оролдоно уу."){
      return Promise.race([promise,new Promise((_,rej)=>setTimeout(()=>rej(new Error(msg)),ms))]);
    }
    function uploadOne(file, path){
      if(file.size > 2*1024*1024) throw new Error(`"${file.name}" 2MB-аас их байна.`);
      const r = sRef(storage, path);
      const task = uploadBytesResumable(r, file, { contentType: file.type });
      return withTimeout(new Promise((res,rej)=>{
        task.on("state_changed",()=>{},rej,()=>res());
      }), 60000).then(()=>getDownloadURL(r));
    }

    // --- SUBMIT ---
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      await ensureAuthReady; // яагаад: auth дутуу үед write/Storage permission-denied болж түгжигдэх эрсдэлтэй

      if(!currentUserId){ showAlert("Нэвтэрсэн эсэхээ дахин шалгана уу."); return; }
      const files = Array.from(fileInput.files||[]);
      if(files.length===0){ showAlert("Ядаж нэг зураг сонгоно уу."); return; }

      submitBtn.disabled = true;
      const oldTxt = submitBtn.textContent;
      submitBtn.textContent = "Илгээж байна…";
      authStatus.textContent = "Зар хадгалж байна, түр хүлээнэ үү...";

      try{
        const formData = new FormData(form);
        const base = {
          manufacturer: formData.get("manufacturer"),
          model: formData.get("model"),
          year: Number(formData.get("year")),
          importYear: formData.get("importYear") ? Number(formData.get("importYear")) : null,
          condition: formData.get("condition"),
          bodyType: formData.get("bodyType") || "",
          doors: formData.get("doors") || "",
          mileage: Number(formData.get("mileage")),
          price: Number(formData.get("price")),
          fuelType: formData.get("fuelType"),
          driveType: formData.get("driveType") || "",
          transmission: formData.get("transmission") || "",
          engineVolume: formData.get("engineVolume") || "",
          exteriorColor: formData.get("exteriorColor") || "",
          interiorColor: formData.get("interiorColor") || "",
          leasing: formData.get("leasing") || "",
          youtubeUrl: formData.get("youtubeUrl") || "",
          tiktokUrl: formData.get("tiktokUrl") || "",
          description: formData.get("description"),
          sellerName: formData.get("sellerName"),
          sellerEmail: formData.get("sellerEmail") || "",
          sellerPhone: formData.get("sellerPhone"),
          messengerWhatsapp: formData.get("messengerWhatsapp")==="on",
          messengerTelegram: formData.get("messengerTelegram")==="on",
          messengerFacebook: formData.get("messengerFacebook")==="on",
          imageUrls: [],
          createdAt: serverTimestamp(),
          posterId: currentUserId
        };

        // заавал талбаруудыг хатуу шалгах
        const required = ["manufacturer","model","year","mileage","price","fuelType","condition","description","sellerName","sellerPhone"];
        for(const k of required){
          const v = base[k];
          if(v===undefined || v===null || v==="" || (typeof v==="number" && Number.isNaN(v))){
            throw new Error(`"${k}" талбарыг зөв бөглөнө үү.`);
          }
        }

        const carsRef = collection(db, "cars");
        const docRef = await withTimeout(addDoc(carsRef, base), 30000);

        // зурагнуудыг зэрэг upload ( хурдан )
        const urls = await Promise.all(files.map((f,i)=>{
          const safe = f.name.replace(/\s+/g,"_");
          const path = `cars/${docRef.id}/${Date.now()}_${i}_${safe}`;
          return uploadOne(f, path);
        }));

        await withTimeout(updateDoc(doc(db,"cars",docRef.id), { imageUrls: urls }), 15000);

        showAlert("Машины зар амжилттай нэмэгдлээ!", "success");
        authStatus.textContent = "Зар амжилттай хадгалагдлаа.";
        form.reset(); fileCountDisplay.textContent = "Одоогоор зураг сонгоогүй байна."; modal.classList.add("hidden");
      }catch(err){
        console.error(err);
        showAlert("Зар илгээхэд алдаа: " + (err?.message || err));
        authStatus.textContent = "Алдаа гарлаа.";
      }finally{
        submitBtn.disabled = false;
        submitBtn.textContent = oldTxt;
      }
    });
  </script>
</body>
</html>
