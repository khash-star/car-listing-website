<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <title>CarsMongolia.mn – Машин зар</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter",
        "Segoe UI", sans-serif;
      background-color: #f3f4f6;
    }
  </style>
</head>
<body class="min-h-screen bg-gray-100">

  <!-- HEADER -->
  <header class="bg-white shadow sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-2xl font-bold text-red-600">CarsMongolia.mn</h1>
      <button
        id="open-modal-btn"
        class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold shadow hover:bg-red-700 flex items-center gap-2"
      >
        <span class="text-xl leading-none">＋</span>
        <span>Зар Оруулах</span>
      </button>
    </div>
  </header>

  <!-- MAIN: ЖАГСААЛТ + ХООСОН ТАЙЛБАР -->
  <main class="max-w-6xl mx-auto px-4 py-8 space-y-6">
    <!-- Хоосон үед харагдах бокс -->
    <div
      id="empty-state"
      class="border-2 border-dashed border-gray-300 rounded-xl bg-white p-8 text-center text-gray-500"
    >
      Энд дараагийн алхам дээр машины жагсаалт, шүүлтүүр, дэлгэрэнгүй хуудас
      гарна. Одоогоор Firestore дотор хадгалсан машинуудыг уншиж байна.
    </div>

    <!-- Машины жагсаалт -->
    <section id="car-list" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
      <!-- JS-ээр картаар бөглөгдөнө -->
    </section>
  </main>

  <!-- 1: ЗАР ОРУУЛАХ МОДАЛ (өмнөх том форм) -->
  <div
    id="add-car-modal"
    class="fixed inset-0 bg-black bg-opacity-60 hidden z-20 flex items-start justify-center px-4 py-6 overflow-y-auto"
  >
    <div
      class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full relative p-6 md:p-8"
    >
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-gray-900">Машины Зар Оруулах</h2>
        <button
          id="close-modal-btn"
          class="text-gray-400 hover:text-gray-600 text-2xl leading-none"
        >
          ×
        </button>
      </div>

      <p class="text-xs text-gray-500 mb-4">
        * тэмдэгтэй талбаруудыг заавал бөглөнө үү.
        Зурагнууд Firebase Storage дээр, зарын мэдээлэл Firestore-д хадгалагдана.
      </p>

      <form id="add-car-form" class="space-y-6">
        <!-- 1. ҮНДСЭН МЭДЭЭЛЭЛ -->
        <div>
          <h3 class="text-lg font-semibold mb-2 text-gray-800">
            1. Машины үндсэн мэдээлэл
          </h3>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label for="manufacturer" class="block text-sm font-medium text-gray-700">
                Үйлдвэрлэгч *
              </label>
              <select
                id="manufacturer"
                name="manufacturer"
                class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500"
                required
              >
                <option value="">Сонгох</option>
                <!-- JS-ээр CAR_DATA-гаас бөглөнө -->
              </select>
            </div>
            <div>
              <label for="model" class="block text-sm font-medium text-gray-700">
                Модель *
              </label>
              <select
                id="model"
                name="model"
                class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500"
                required
              >
                <option value="">Эхлээд үйлдвэрлэгч сонгоно уу</option>
              </select>
            </div>
            <div>
              <label for="year" class="block text-sm font-medium text-gray-700">
                Үйлдвэрлэсэн он *
              </label>
              <input
                type="number"
                id="year"
                name="year"
                min="1980"
                max="2099"
                class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500"
                required
              />
            </div>
            <div>
              <label for="importYear" class="block text-sm font-medium text-gray-700">
                Орж ирсэн он
              </label>
              <input
                type="number"
                id="importYear"
                name="importYear"
                min="1980"
                max="2099"
                class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300"
              />
            </div>
          </div>

          <div class="grid md:grid-cols-3 gap-4 mt-4">
            <div>
              <label for="condition" class="block text-sm font-medium text-gray-700">
                Нөхцөл *
              </label>
              <select
                id="condition"
                name="condition"
                class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500"
                required
              >
                <option value="Дугаар аваагүй">Дугаар аваагүй</option>
                <option value="Дугаар авсан">Дугаар авсан</option>
                <option value="Шинэ">Шинэ</option>
                <option value="Хуучин">Хуучин</option>
              </select>
            </div>
            <div>
              <label for="bodyType" class="block text-sm font-medium text-gray-700">
                Төрөл
              </label>
              <select
                id="bodyType"
                name="bodyType"
                class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300"
              >
                <option value="">Сонгох</option>
                <option value="Суудлын">Суудлын</option>
                <option value="Жийп">Жийп</option>
                <option value="Микро">Микро</option>
                <option value="Ачааны">Ачааны</option>
                <option value="Бусад">Бусад</option>
              </select>
            </div>
            <div>
              <label for="doors" class="block text-sm font-medium text-gray-700">
                Хаалга
              </label>
              <select
                id="doors"
                name="doors"
                class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300"
              >
                <option value="">Сонгох</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
          </div>
        </div>

        <!-- 2. ТЕХНИК МЭДЭЭЛЭЛ -->
        <div>
          <h3 class="text-lg font-semibold mb-2 text-gray-800">
            2. Техникийн үзүүлэлт
          </h3>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label for="mileage" class="block text-sm font-medium text-gray-700">
                Гүйлт (км) *
              </label>
              <input
                type="number"
                id="mileage"
                name="mileage"
                min="0"
                class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500"
                required
              />
            </div>
            <div>
              <label for="price" class="block text-sm font-medium text-gray-700">
                Үнэ (сая ₮) *
              </label>
              <input
                type="number"
                id="price"
                name="price"
                step="0.1"
                min="0.1"
                class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500"
                required
              />
            </div>
            <div>
              <label for="fuelType" class="block text-sm font-medium text-gray-700">
                Түлш *
              </label>
              <select
                id="fuelType"
                name="fuelType"
                class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500"
                required
              >
                <option value="Бензин">Бензин</option>
                <option value="Дизель">Дизель</option>
                <option value="Хибрид">Хибрид</option>
                <option value="Цахилгаан">Цахилгаан</option>
                <option value="Хий">Хий</option>
                <option value="Бусад">Бусад</option>
              </select>
            </div>
            <div>
              <label for="driveType" class="block text-sm font-medium text-gray-700">
                Хөтлөгч
              </label>
              <select
                id="driveType"
                name="driveType"
                class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300"
              >
                <option value="">Сонгох</option>
                <option value="Урд">Урд</option>
                <option value="Хойд">Хойд</option>
                <option value="Бүх дугуй 4WD">Бүх дугуй 4WD</option>
              </select>
            </div>
            <div>
              <label for="transmission" class="block text-sm font-medium text-gray-700">
                Хурдны хайрцаг
              </label>
              <select
                id="transmission"
                name="transmission"
                class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300"
              >
                <option value="">Сонгох</option>
                <option value="Автомат">Автомат</option>
                <option value="Механик">Механик</option>
                <option value="Хос сцепление">Хос сцепление</option>
              </select>
            </div>
            <div>
              <label for="engineVolume" class="block text-sm font-medium text-gray-700">
                Мотор багтаамж (л)
              </label>
              <input
                type="text"
                id="engineVolume"
                name="engineVolume"
                placeholder="Жишээ: 2.4"
                class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300"
              />
            </div>
          </div>

          <div class="grid md:grid-cols-3 gap-4 mt-4">
            <div>
              <label for="exteriorColor" class="block text-sm font-medium text-gray-700">
                Гадна өнгө
              </label>
              <input
                type="text"
                id="exteriorColor"
                name="exteriorColor"
                class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300"
              />
            </div>
            <div>
              <label for="interiorColor" class="block text-sm font-medium text-gray-700">
                Дотор өнгө
              </label>
              <input
                type="text"
                id="interiorColor"
                name="interiorColor"
                class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300"
              />
            </div>
            <div>
              <label for="leasing" class="block text-sm font-medium text-gray-700">
                Лизинг
              </label>
              <select
                id="leasing"
                name="leasing"
                class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300"
              >
                <option value="Лизинггүй">Лизинггүй</option>
                <option value="Лизингтэй">Лизингтэй</option>
              </select>
            </div>
          </div>
        </div>

        <!-- 3. ЗУРАГ, ВИДЕО -->
        <div>
          <h3 class="text-lg font-semibold mb-2 text-gray-800">
            3. Зураг, видео
          </h3>
          <div class="space-y-3">
            <div>
              <label for="carImages" class="block text-sm font-medium text-gray-700">
                Зурагнууд (олон сонгож болно) *
              </label>
              <input
                type="file"
                id="carImages"
                name="carImages"
                accept="image/*"
                multiple
                class="mt-1 w-full text-sm"
                required
              />
              <p id="file-count-display" class="text-xs text-gray-500 mt-1">
                Одоогоор зураг сонгоогүй байна.
              </p>
              <p class="text-xs text-gray-400">
                Нэг зураг 2MB-аас бага байхыг зөвлөж байна. Зургууд Firebase
                Storage дээр хадгалагдана.
              </p>
            </div>
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label for="youtubeUrl" class="block text-sm font-medium text-gray-700">
                  YouTube URL
                </label>
                <input
                  type="url"
                  id="youtubeUrl"
                  name="youtubeUrl"
                  placeholder="https://www.youtube.com/..."
                  class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300"
                />
              </div>
              <div>
                <label for="tiktokUrl" class="block text-sm font-medium text-gray-700">
                  TikTok линк
                </label>
                <input
                  type="url"
                  id="tiktokUrl"
                  name="tiktokUrl"
                  placeholder="https://www.tiktok.com/..."
                  class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300"
                />
              </div>
            </div>
          </div>
        </div>

        <!-- 4. ЗАРЫН ТАЙЛБАР -->
        <div>
          <h3 class="text-lg font-semibold mb-2 text-gray-800">
            4. Зарын тайлбар
          </h3>
          <textarea
            id="description"
            name="description"
            rows="4"
            class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500"
            placeholder="Машиныгаа аль болох дэлгэрэнгүй, үнэн зөв тайлбарлана уу."
            required
          ></textarea>
        </div>

        <!-- 5. ЗАР ОРУУЛАГЧИЙН МЭДЭЭЛЭЛ -->
        <div>
          <h3 class="text-lg font-semibold mb-2 text-gray-800">
            5. Зар оруулагчийн мэдээлэл
          </h3>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label for="sellerName" class="block text-sm font-medium text-gray-700">
                Нэр / Дэлгүүр *
              </label>
              <input
                type="text"
                id="sellerName"
                name="sellerName"
                class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500"
                required
              />
            </div>
            <div>
              <label for="sellerEmail" class="block text-sm font-medium text-gray-700">
                Имэйл
              </label>
              <input
                type="email"
                id="sellerEmail"
                name="sellerEmail"
                class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-gray-300"
              />
            </div>
            <div>
              <label for="sellerPhone" class="block text-sm font-medium text-gray-700">
                Утас *
              </label>
              <input
                type="tel"
                id="sellerPhone"
                name="sellerPhone"
                placeholder="+97699998888"
                class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500"
                required
              />
            </div>
            <div>
              <span class="block text-sm font-medium text-gray-700 mb-1">
                Холбогдох сувгууд
              </span>
              <label class="inline-flex items-center mr-4 text-sm">
                <input type="checkbox" name="messengerWhatsapp" class="mr-1" />
                Whatsapp
              </label>
              <label class="inline-flex items-center mr-4 text-sm">
                <input type="checkbox" name="messengerTelegram" class="mr-1" />
                Telegram
              </label>
              <label class="inline-flex items-center text-sm">
                <input type="checkbox" name="messengerFacebook" class="mr-1" />
                Facebook Messenger
              </label>
            </div>
          </div>
        </div>

        <div class="pt-2 flex items-center justify-between gap-4">
          <p id="auth-status" class="text-xs text-gray-500">
            Firebase-д холбогдож байна...
          </p>
          <button
            type="submit"
            id="submit-car-btn"
            class="bg-red-600 text-white px-6 py-2.5 rounded-lg font-semibold shadow hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            Зар Нэмэх
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 2: ДЭЛГЭРЭНГҮЙ МОДАЛ -->
  <div
    id="car-detail-modal"
    class="fixed inset-0 bg-black bg-opacity-60 hidden z-20 flex items-center justify-start px-4 py-6 overflow-y-auto"
  >
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full relative p-6 md:p-8">
      <div class="flex items-center justify-between mb-4">
        <h2 id="detail-title" class="text-2xl font-bold text-gray-900">
          Машины дэлгэрэнгүй
        </h2>
        <button
          id="detail-close-btn"
          class="text-gray-400 hover:text-gray-600 text-2xl leading-none"
        >
          ×
        </button>
      </div>

      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <div class="relative pb-[56%] rounded-xl overflow-hidden bg-gray-100">
            <img
              id="detail-main-image"
              src=""
              alt=""
              class="absolute inset-0 w-full h-full object-cover"
            />
          </div>
          <div
            id="detail-thumbs"
            class="mt-3 flex gap-2 overflow-x-auto"
          ></div>
        </div>

        <div class="space-y-3 text-sm">
          <p id="detail-price" class="text-xl font-bold text-red-600"></p>
          <p id="detail-basic" class="text-gray-700"></p>

          <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-gray-600">
            <span class="font-semibold">Гүйлт:</span>
            <span id="detail-mileage"></span>

            <span class="font-semibold">Түлш:</span>
            <span id="detail-fuel"></span>

            <span class="font-semibold">Хөтлөгч:</span>
            <span id="detail-drive"></span>

            <span class="font-semibold">Хурдны хайрцаг:</span>
            <span id="detail-transmission"></span>

            <span class="font-semibold">Мотор:</span>
            <span id="detail-engine"></span>

            <span class="font-semibold">Өнгө (гадаад / дотоод):</span>
            <span id="detail-colors"></span>

            <span class="font-semibold">Лизинг:</span>
            <span id="detail-leasing"></span>
          </div>

          <div class="pt-2 border-t text-xs text-gray-600 space-y-1">
            <p class="font-semibold">Зар оруулагч:</p>
            <p id="detail-seller"></p>
            <p id="detail-phone"></p>
            <p id="detail-contact-channels"></p>
          </div>

          <div class="pt-2 border-t text-xs text-gray-600">
            <p class="font-semibold">Тайлбар:</p>
            <p id="detail-description" class="whitespace-pre-line"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ALERT BOX -->
  <div
    id="custom-alert"
    class="hidden fixed bottom-4 right-4 max-w-sm bg-red-600 text-white rounded-xl shadow-xl p-4 text-sm z-30"
  >
    <p class="font-bold mb-1" id="alert-title">АЛДАА</p>
    <p id="alert-message"></p>
    <button
      onclick="document.getElementById('custom-alert').classList.add('hidden')"
      class="mt-2 text-xs underline"
    >
      Хаах
    </button>
  </div>

  <!-- FIREBASE + APP LOGIC -->
 <script type="module">
  // ---------- FIREBASE IMPORT ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    serverTimestamp,
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import {
    getAuth,
    signInAnonymously,
    onAuthStateChanged,
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

  // ---------- FIREBASE CONFIG ----------
  const firebaseConfig = {
    apiKey: "AIzaSyAEW1YnJ_xm_YnPzW9y1iSmdQIrgOsfjlA",
    authDomain: "carsmongolia-d410a.firebaseapp.com",
    projectId: "carsmongolia-d410a",
    storageBucket: "carsmongolia-d410a.appspot.com",
    messagingSenderId: "483533885994",
    appId: "1:483533885994:web:e6718b4668f1896cf32953",
    measurementId: "G-8BR11G8E5Z",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // ---------- UI ЭЛЕМЕНТҮҮД ----------
  const modal = document.getElementById("add-car-modal");
  const openBtn = document.getElementById("open-modal-btn");
  const closeBtn = document.getElementById("close-modal-btn");
  const form = document.getElementById("add-car-form");

  const fileInput = document.getElementById("carImages");
  const fileCountDisplay = document.getElementById("file-count-display");

  const submitBtn = document.getElementById("submit-car-btn");
  const authStatus = document.getElementById("auth-status");

  const alertBox = document.getElementById("custom-alert");
  const alertTitle = document.getElementById("alert-title");
  const alertMessage = document.getElementById("alert-message");

  // ---------- ЖИЖИГ АЛЕРТ ФУНКЦ ----------
  function showAlert(message, type = "error") {
    alertMessage.textContent = message;
    alertTitle.textContent = type === "success" ? "АМЖИЛТ" : "АЛДАА";
    alertBox.classList.remove("hidden", "bg-red-600", "bg-green-600");
    alertBox.classList.add(type === "success" ? "bg-green-600" : "bg-red-600");
  }

  // ---------- MODAL ОНГОЙЛГОХ / ХААХ ----------
  openBtn.addEventListener("click", () => {
    modal.classList.remove("hidden");
  });

  closeBtn.addEventListener("click", () => {
    modal.classList.add("hidden");
  });

  modal.addEventListener("click", (e) => {
    if (e.target === modal) modal.classList.add("hidden");
  });

  // ---------- ФАЙЛ СОНГОХ ----------
  fileInput.addEventListener("change", () => {
    const count = fileInput.files.length;
    fileCountDisplay.textContent =
      count === 0 ? "Одоогоор зураг сонгоогүй байна." : `${count} файл сонгосон`;
  });

  // ---------- FIREBASE AUTH (АНОНИМ) ----------
  let currentUserId = null;

  async function startAuth() {
    try {
      await signInAnonymously(auth);
    } catch (err) {
      console.error(err);
      authStatus.textContent = "Firebase нэвтрэлт амжилтгүй.";
      showAlert("Firebase нэвтрэлт амжилтгүй: " + err.message);
    }
  }

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUserId = user.uid;
      authStatus.textContent = "Firebase-т нэвтэрсэн. Зар оруулж болно.";
      submitBtn.disabled = false;
    } else {
      currentUserId = null;
      submitBtn.disabled = true;
      authStatus.textContent = "Firebase-т холбогдож байна...";
      startAuth();
    }
  });

  // ---------- ЗУРГИЙГ BASE64 БОЛГОХ ФУНКЦ ----------
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        // dataURL → "data:image/jpeg;base64,AAAA..." хэлбэртэй
        const dataUrl = reader.result;
        // хүсвэл "data:..." хэсгийг салгаж болно
        const base64 = String(dataUrl).split(",")[1];
        resolve({
          mimeType: file.type,
          base64,
        });
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // ---------- ФОРМ ИЛГЭЭХ ----------
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!currentUserId) {
      showAlert("Firebase-т нэвтэртэл жаахан хүлээгээд дахин оролдоно уу.");
      return;
    }

    const files = fileInput.files;
    if (!files || files.length === 0) {
      showAlert("Ядаж нэг зураг заавал сонгоно уу.");
      return;
    }

    // Одоохондоо аюулгүй байлгахын тулд хамгийн ихдээ 3 зураг
    if (files.length > 3) {
      showAlert("Одоогоор хамгийн ихдээ 3 зураг оруулах боломжтой.");
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = "Илгээж байна...";
    authStatus.textContent = "Зар хадгалж байна, түр хүлээнэ үү...";

    try {
      const formData = new FormData(form);

      // --- Зургуудыг Base64 болгон хөрвүүлэх ---
      const base64Images = [];
      let totalBytesApprox = 0;

      for (let i = 0; i < files.length; i++) {
        const file = files[i];

        if (!file.type.startsWith("image/")) {
          showAlert("Зөвхөн зураг (JPG/PNG) файл оруулна уу.");
          throw new Error("Not image");
        }

        const { mimeType, base64 } = await fileToBase64(file);

        // Баримтын 1MB лимитээс хэтрэхгүй байлгахын тулд ойролцоогоор тооцоолно
        const bytes = (base64.length * 3) / 4;
        totalBytesApprox += bytes;

        if (totalBytesApprox > 800000) {
          showAlert(
            "Зургийн нийт хэмжээ хэтэрлээ (ойролцоогоор > 800KB). Илүү жижиг зураг сонгоно уу."
          );
          throw new Error("Too big");
        }

        base64Images.push({
          mimeType,
          data: base64,
        });
      }

      // --- МАШИНЫ МЭДЭЭЛЭЛ БЭЛДЭХ ---
      const carDocData = {
        manufacturer: formData.get("manufacturer"),
        model: formData.get("model"),
        year: Number(formData.get("year")),
        importYear: formData.get("importYear")
          ? Number(formData.get("importYear"))
          : null,
        condition: formData.get("condition"),
        bodyType: formData.get("bodyType") || "",
        doors: formData.get("doors") || "",
        mileage: Number(formData.get("mileage")),
        price: Number(formData.get("price")),
        fuelType: formData.get("fuelType"),
        driveType: formData.get("driveType") || "",
        transmission: formData.get("transmission") || "",
        engineVolume: formData.get("engineVolume") || "",
        exteriorColor: formData.get("exteriorColor") || "",
        interiorColor: formData.get("interiorColor") || "",
        leasing: formData.get("leasing") || "",
        youtubeUrl: formData.get("youtubeUrl") || "",
        tiktokUrl: formData.get("tiktokUrl") || "",
        description: formData.get("description"),
        sellerName: formData.get("sellerName"),
        sellerEmail: formData.get("sellerEmail") || "",
        sellerPhone: formData.get("sellerPhone"),
        messengerWhatsapp: formData.get("messengerWhatsapp") === "on",
        messengerTelegram: formData.get("messengerTelegram") === "on",
        messengerFacebook: formData.get("messengerFacebook") === "on",

        // Base64 зурагнууд
        images: base64Images, // [{mimeType, data}, ...]
        createdAt: serverTimestamp(),
        posterId: currentUserId,
      };

      const carsRef = collection(db, "cars");
      await addDoc(carsRef, carDocData);

      showAlert("Машины зар амжилттай нэмэгдлээ!", "success");
      authStatus.textContent = "Зар амжилттай хадгалагдлаа.";

      form.reset();
      fileCountDisplay.textContent = "Одоогоор зураг сонгоогүй байна.";
      modal.classList.add("hidden");
    } catch (err) {
      if (err && err.message === "Too big") {
        // аль хэдийн алерт харуулсан
      } else if (err && err.message === "Not image") {
        // аль хэдийн алерт
      } else {
        console.error(err);
        showAlert("Зар илгээхэд алдаа гарлаа: " + (err?.message || err));
        authStatus.textContent = "Алдаа гарлаа.";
      }
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Зар Нэмэх";
    }
  });
</script>
</body>
</html>
